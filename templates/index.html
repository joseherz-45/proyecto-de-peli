<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Películas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        h1 {
            color: #343a40;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .modal-body img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gestión de Películas</h1>

        <!-- Pestañas -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="peliculas-tab" data-toggle="tab" href="#peliculas" role="tab" aria-controls="peliculas" aria-selected="true">Películas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="agregar-tab" data-toggle="tab" href="#agregar" role="tab" aria-controls="agregar" aria-selected="false">Editar Película</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="#" data-toggle="tab" href="#" role="tab" aria-controls="#" aria-selected="false">crear</a>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="peliculas" role="tabpanel" aria-labelledby="peliculas-tab">
                <table class="table mt-3 table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Título</th>
                            <th>Descripción</th>
                            <th>Fecha de Lanzamiento</th>
                            <th>Poster</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movie in movies %}
                        <tr data-id="{{ movie.id }}">
                            <td>{{ movie.title }}</td>
                            <td>{{ movie.overview }}</td>
                            <td>{{ movie.release_date.strftime('%Y-%m-%d') if movie.release_date else 'N/A' }}</td>
                            <td>
                                {% if movie.poster_path and not movie.poster_path.startswith('/') %}
                                    <img src="{{ url_for('static', filename='uploads/' + movie.poster_path) }}" alt="Poster de {{ movie.title }}" width="100">
                                {% else %}
                                    <img src="{{ url_for('static', filename='default_poster.jpg') }}" alt="Sin poster" width="100">
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-info btn-view">Ver</button>
                                <button class="btn btn-warning btn-edit">Editar</button>
                                <button class="btn btn-danger btn-delete">Eliminar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="tab-pane fade" id="agregar" role="tabpanel" aria-labelledby="agregar-tab">
                <h2 class="mt-3">Editar Película</h2>
                <form id="movie-form" enctype="multipart/form-data">
                    <input type="hidden" id="movie-id" name="movie_id">
                    <div class="form-group">
                        <label for="title">Título</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="overview">Descripción</label>
                        <textarea class="form-control" id="overview" name="overview" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="release_date">Fecha de Lanzamiento</label>
                        <input type="date" class="form-control" id="release_date" name="release_date" required>
                    </div>
                    <div class="form-group">
                        <label for="image_file">Imagen</label>
                        <input type="file" class="form-control" id="image_file" name="image_file" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit">Cancelar</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Manejar el clic en el botón de crear nueva película
            $('#agregar-tab').on('click', function() {
                $('#movie-form')[0].reset(); // Restablecer el formulario
                $('#movie-id').val(''); // Limpiar el ID de la película
            });

            // Manejar el clic en el botón de ver
            $('.btn-view').on('click', function() {
                const row = $(this).closest('tr');
                const title = row.find('td').eq(0).text();
                const overview = row.find('td').eq(1).text();
                const releaseDate = row.find('td').eq(2).text();
                const poster = row.find('td img').attr('src');

                // Mostrar un modal con la información de la película
                $('#viewModal .modal-title').text(title);
                $('#viewModal .modal-body').html(`
                    <p><strong>Descripción:</strong> ${overview}</p>
                    <p><strong>Fecha de Lanzamiento:</strong> ${releaseDate}</p>
                    <img src="${poster}" alt="${title} Poster" class="img-fluid">
                `);
                $('#viewModal').modal('show');
            });

            // Manejar el clic en el botón de editar
            $('.btn-edit').on('click', function() {
                const row = $(this).closest('tr');
                const movieId = row.data('id');
                const title = row.find('td').eq(0).text();
                const overview = row.find('td').eq(1).text();
                const releaseDate = row.find('td').eq(2).text();

                $('#movie-id').val(movieId);
                $('#title').val(title);
                $('#overview').val(overview);
                
                const formattedReleaseDate = new Date(releaseDate).toISOString().split('T')[0];
                $('#release_date').val(formattedReleaseDate);
                $('#myTab a[href="#agregar"]').tab('show'); // Cambiar a la pestaña de agregar
            });

            // Manejar el envío del formulario
            $('#movie-form').on('submit', function(event) {
                event.preventDefault(); // Evitar el envío normal del formulario

                const movieId = $('#movie-id').val();
                const formData = new FormData(this);

                const url = movieId ? `/editar_pelicula/${movieId}` : '/agregar_pelicula';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert(response.mensaje);
                        location.reload(); // Recargar la página para ver los cambios
                    },
                    error: function(xhr) {
                        alert(xhr.responseJSON.mensaje || 'Error al guardar la película.'); // Manejo de errores más robusto
                    }
                });
            });

            // Manejar el clic en el botón de eliminar
            $('.btn-delete').on('click', function() {
                const row = $(this).closest('tr');
                const movieId = row.data('id');

                if (confirm('¿Estás seguro de que deseas eliminar esta película?')) {
                    $.ajax({
                        url: `/eliminar_pelicula/${movieId}`,
                        type: 'DELETE',
                        success: function(response) {
                            alert(response.mensaje);
                            location.reload(); // Recargar la página para ver los cambios
                        },
                        error: function(xhr) {
                            alert(xhr.responseJSON.mensaje || 'Error al eliminar la película.'); // Manejo de errores más robusto
                        }
                    });
                }
            });

            // Manejar el clic en el botón de cancelar
            $('#cancel-edit').on('click', function() {
                $('#movie-form')[0].reset(); // Restablecer el formulario
                $('#movie-id').val(''); // Limpiar el ID de la película
                $('#myTab a[href="#peliculas"]').tab('show'); // Volver a la pestaña de películas
            });
        });
    </script>

    <!-- Modal para ver detalles de la película -->
    <div class="modal fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalLabel">Detalles de la Película</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>
</body>
</html>
